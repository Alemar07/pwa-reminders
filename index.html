<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recordatorios por WhatsApp</title>
<meta name="theme-color" content="#22c55e">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22c55e;
    --danger:#ef4444; --outline:#1f2937;
  }
  html,body{height:100%}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
       background: radial-gradient(1200px 600px at 20% -10%, #1f2937 0%, #0b1220 40%, #060a14 100%) fixed;}
  .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
  .card{width:100%; max-width:680px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border:1px solid #1f2937; border-radius:20px; box-shadow: 0 8px 40px rgba(0,0,0,.45); overflow:hidden}
  header{padding:22px 22px 0; display:flex; align-items:center; gap:14px}
  .logo{width:42px; height:42px; border-radius:10px; background: linear-gradient(135deg,#10b981, #22c55e); display:grid; place-items:center; color:white; font-weight:900}
  header h1{margin:0; font-size:18px; color:var(--txt)}
  header p{margin:2px 0 0; color:var(--muted); font-size:12px}
  .body{padding:22px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label{display:block; font-size:12px; color:var(--muted); margin:6px 0 8px}
  input, select, button, textarea{
    width:100%; background:#0b1020; color:var(--txt); border:1px solid var(--outline); border-radius:12px;
    padding:12px 14px; outline:none; transition:.15s border, .15s transform;
  }
  input:focus, select:focus, textarea:focus{ border-color:#334155; box-shadow: 0 0 0 3px rgba(51,65,85,.25)}
  button{cursor:pointer; font-weight:600}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px}
  .btn-primary{ background:linear-gradient(180deg,#22c55e,#16a34a); border:none}
  .btn-ghost{ background:transparent; border:1px dashed #334155; color:#cbd5e1}
  .btn-danger{ background:linear-gradient(180deg,#ef4444,#dc2626); border:none}
  .muted{color:var(--muted); font-size:12px}
  .hint{margin-top:10px; color:#9ca3af; font-size:12px}
  .footer{padding:14px 22px 22px; display:flex; justify-content:space-between; gap:10px}
  .tag{display:inline-flex; align-items:center; gap:8px; background:#0b1020; border:1px solid #243044;
       color:#cbd5e1; border-radius:999px; padding:6px 10px; font-size:12px}
  .ok{color:#10b981}
  .err{color:#fca5a5}
  .split{height:1px; background:#1f2937; margin:16px 0}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#0b1020; border:1px solid #1f2937; font-size:12px; color:#cbd5e1}
  .actions{display:flex; gap:12px; flex-wrap:wrap}
  .right{display:flex; gap:10px; align-items:center}
  .danger-link{color:#fca5a5; cursor:pointer; text-decoration:underline; font-size:12px}
  .center{display:flex; justify-content:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="logo">WA</div>
      <div>
        <h1>Recordatorios por WhatsApp</h1>
        <p>Privado, sin servidores, 100% gratis</p>
      </div>
    </header>
    <div class="body">

      <!-- Vistas -->
      <div id="setupView" style="display:none">
        <div class="split"></div>
        <p class="muted">Primer uso · Crea tu usuario único. La contraseña <b>cifra</b> la libreta de contactos en este navegador.</p>
        <div class="row">
          <div>
            <label>Usuario</label>
            <input id="setupUser" placeholder="ej. admin" autocomplete="username">
          </div>
          <div>
            <label>Contraseña</label>
            <input id="setupPass" type="password" placeholder="••••••••" autocomplete="new-password">
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button id="btnSetup" class="btn btn-primary">Crear y acceder</button>
        </div>
        <p class="hint">Todo se guarda localmente y cifrado (AES-GCM + PBKDF2). Si olvidas la contraseña, los contactos no se podrán recuperar.</p>
      </div>

      <div id="loginView" style="display:none">
        <div class="split"></div>
        <div class="row">
          <div>
            <label>Usuario</label>
            <input id="loginUser" placeholder="Tu usuario" autocomplete="username">
          </div>
          <div>
            <label>Contraseña</label>
            <input id="loginPass" type="password" placeholder="Tu contraseña" autocomplete="current-password">
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button id="btnLogin" class="btn btn-primary">Entrar</button>
          <button id="btnReset" class="btn btn-ghost" title="Borra toda la app">Borrar datos de la app</button>
        </div>
        <p class="hint">Consejo: fija este sitio como app (PWA) en tu móvil/escritorio para acceso directo.</p>
      </div>

      <div id="appView" style="display:none">
        <div class="split"></div>
        <div class="row">
          <div>
            <label>Fecha y hora del recordatorio</label>
            <input id="dt" type="datetime-local">
          </div>
          <div>
            <label>Contacto (teléfono en formato internacional)</label>
            <select id="contactSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div>
            <label>Mensaje a enviar</label>
            <textarea id="msg" rows="4" placeholder="Se generará automáticamente, pero puedes editarlo."></textarea>
            <p class="hint">Se abrirá WhatsApp/WhatsApp Web con este mensaje pre-rellenado para que confirmes el envío.</p>
          </div>
          <div>
            <label>Acciones</label>
            <div class="actions">
              <button id="btnSend" class="btn btn-primary">Enviar por WhatsApp</button>
              <button id="btnCopy" class="btn btn-ghost">Copiar enlace de WhatsApp</button>
            </div>
            <div class="split"></div>
            <div>
              <label>Gestionar contactos</label>
              <div class="row">
                <input id="newName" placeholder="Nombre (ej. Marta)">
                <input id="newPhone" placeholder="Teléfono (ej. +34600111222)">
              </div>
              <div class="actions" style="margin-top:10px">
                <button id="btnAdd" class="btn btn-ghost">Añadir contacto</button>
                <button id="btnRemove" class="btn btn-danger">Eliminar contacto seleccionado</button>
              </div>
              <p class="hint">Formato E.164 recomendado: +34…, +52…, etc.</p>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="footer">
      <div class="tag">Estado: <span id="status" style="margin-left:6px" class="ok">Listo</span></div>
      <div class="right">
        <span id="who" class="pill">—</span>
        <span id="logout" class="danger-link" style="display:none">Cerrar sesión</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Utilidades ===== */
const enc = new TextEncoder(); const dec = new TextDecoder();
const S = {
  key:null, user:null, stateKey:'wa-reminders-app-v1',
  state(){ return JSON.parse(localStorage.getItem(this.stateKey) || 'null') },
  save(obj){ localStorage.setItem(this.stateKey, JSON.stringify(obj)) },
  clear(){ localStorage.removeItem(this.stateKey) }
};
const qs = sel => document.querySelector(sel);
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const ubuf = b64s => Uint8Array.from(atob(b64s), c => c.charCodeAt(0)).buffer;

function setStatus(text, ok=true){ const el=$('#status'); if(el){el.textContent=text; el.className = ok ? 'ok' : 'err';} }

/* Fecha/hora por defecto: ahora + 1 hora */
function setDefaultDate(){
  const d = new Date(Date.now()+60*60*1000);
  const isoLocal = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  const dt = $('#dt'); if(dt) dt.value = isoLocal;
}

/* ===== Cripto (PBKDF2 + AES-GCM) ===== */
async function derive(password, saltB64){
  const salt = saltB64 ? ubuf(saltB64) : crypto.getRandomValues(new Uint8Array(16)).buffer;
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']);
  const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:250000, hash:'SHA-256'}, baseKey, 256);
  const keyBytes = new Uint8Array(bits);
  const pwHash = await crypto.subtle.digest('SHA-256', keyBytes);
  const aesKey = await crypto.subtle.importKey('raw', keyBytes, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
  return { aesKey, pwHashB64: b64(pwHash), saltB64: b64(salt) };
}
async function encryptJson(aesKey, obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = enc.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, aesKey, data);
  return { iv: b64(iv), ct: b64(ct) };
}
async function decryptJson(aesKey, pack){
  const iv = ubuf(pack.iv); const ct = ubuf(pack.ct);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv:new Uint8Array(iv)}, aesKey, ct);
  return JSON.parse(dec.decode(pt));
}

/* ===== Vistas ===== */
function show(id){
  ['setupView','loginView','appView'].forEach(v=>{
    const el = document.getElementById(v);
    if (el) el.style.display = (v===id?'block':'none');
  });
  const l = document.getElementById('logout');
  if (l) l.style.display = (id==='appView') ? 'inline' : 'none';
}
function refreshContactsSelect(list){
  const sel = $('#contactSelect'); if(!sel) return;
  sel.innerHTML='';
  if (!list || list.length===0){ const opt=document.createElement('option'); opt.value=''; opt.text='— Sin contactos —'; sel.add(opt); return; }
  for (const c of list){ const opt=document.createElement('option'); opt.value=c.phone; opt.text=`${c.name} (${c.phone})`; sel.add(opt); }
}
function isPhoneValid(p){ return /^\+\d{6,15}$/.test(p); }

/* ===== Mensaje ===== */
function buildMessage(){
  const dtVal = $('#dt') ? $('#dt').value : null;
  const when = dtVal ? new Date(dtVal) : new Date();
  const d = when.toLocaleDateString(undefined, {weekday:'long', day:'2-digit', month:'long', year:'numeric'});
  const t = when.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'});
  return `¡Hola! 👋 Tienes un recordatorio para el ${d} a las ${t}.`;
}
function updateMessage(){ const m=$('#msg'); if(m) m.value = buildMessage(); }

/* ===== App ===== */
async function init(){
  const state = S.state();
  if (!state){ show('setupView'); setStatus('Primer uso'); return; }
  show('loginView'); setStatus('Introduce tus credenciales');
}

document.addEventListener('DOMContentLoaded', ()=>{
  init();
  setDefaultDate();
  updateMessage();

  // Setup (primer uso)
  $('#btnSetup')?.addEventListener('click', async ()=>{
    const user = $('#setupUser').value.trim();
    const pass = $('#setupPass').value;
    if (!user || pass.length<6){ setStatus('Usuario y contraseña (>=6) requeridos', false); return; }
    const {aesKey, pwHashB64, saltB64} = await derive(pass);
    S.key = aesKey; S.user = user;
    const emptyContacts = { list: [] };
    const pack = await encryptJson(aesKey, emptyContacts);
    S.save({ user, pwHashB64, saltB64, vault: pack });
    const who=$('#who'); if(who) who.textContent = `Conectado: ${user}`;
    refreshContactsSelect([]);
    show('appView'); setStatus('Sesión iniciada');
  });

  // Login
  $('#btnLogin')?.addEventListener('click', async ()=>{
    const user = $('#loginUser').value.trim();
    const pass = $('#loginPass').value;
    const state = S.state();
    if (!state){ setStatus('No hay datos guardados. Crea una cuenta.', false); show('setupView'); return; }
    if (user !== state.user){ setStatus('Usuario incorrecto', false); return; }
    try{
      const {aesKey, pwHashB64} = await derive(pass, state.saltB64);
      if (pwHashB64 !== state.pwHashB64){ setStatus('Contraseña incorrecta', false); return; }
      const vault = await decryptJson(aesKey, state.vault);
      S.key = aesKey; S.user = user;
      const who=$('#who'); if(who) who.textContent = `Conectado: ${user}`;
      refreshContactsSelect(vault.list);
      show('appView'); setStatus('Sesión iniciada');
    }catch(e){ console.error(e); setStatus('Error al descifrar datos', false); }
  });

  // Logout & Reset
  $('#logout')?.addEventListener('click', ()=>{ show('loginView'); setStatus('Sesión cerrada'); const lp=$('#loginPass'); if(lp) lp.value=''; });
  $('#btnReset')?.addEventListener('click', ()=>{ if(confirm('Esto borrará TODA la app (usuario, contactos). ¿Continuar?')){ S.clear(); location.reload(); } });

  // Gestión de contactos
  async function loadVault(){ const state = S.state(); return state ? await decryptJson(S.key, state.vault) : { list: [] }; }
  async function saveVault(vault){ const pack = await encryptJson(S.key, vault); const st = S.state(); st.vault = pack; S.save(st); }

  $('#btnAdd')?.addEventListener('click', async ()=>{
    const name = $('#newName').value.trim();
    const phone = $('#newPhone').value.trim();
    if (!name || !isPhoneValid(phone)){ setStatus('Nombre y teléfono válido (+ prefijo) requeridos', false); return; }
    const vault = await loadVault();
    if (vault.list.some(c=>c.phone===phone)){ setStatus('Ese teléfono ya existe', false); return; }
    vault.list.push({name, phone});
    await saveVault(vault);
    refreshContactsSelect(vault.list);
    $('#newName').value=''; $('#newPhone').value='';
    setStatus('Contacto añadido');
  });

  $('#btnRemove')?.addEventListener('click', async ()=>{
    const sel = $('#contactSelect'); const phone = sel ? sel.value : '';
    if (!phone){ setStatus('No hay contacto seleccionado', false); return; }
    const vault = await loadVault();
    const before = vault.list.length;
    vault.list = vault.list.filter(c=>c.phone!==phone);
    await saveVault(vault);
    refreshContactsSelect(vault.list);
    setStatus(before!==vault.list.length ? 'Contacto eliminado' : 'No se encontró el contacto', before!==vault.list.length);
  });

  // Fecha → refrescar mensaje
  $('#dt')?.addEventListener('change', updateMessage);

  // Enviar / copiar enlace WhatsApp
  function buildWaLink(){
    const sel = $('#contactSelect'); const phone = sel ? sel.value : '';
    if (!isPhoneValid(phone)) return null;
    const msg = $('#msg') ? $('#msg').value.trim() : '';
    const text = encodeURIComponent(msg || buildMessage());
    return `https://wa.me/${phone.replace('+','')}/?text=${text}`;
  }
  $('#btnSend')?.addEventListener('click', ()=>{
    const url = buildWaLink();
    if (!url){ setStatus('Selecciona un contacto válido', false); return; }
    window.open(url, '_blank');
    setStatus('Abriendo WhatsApp…');
  });
  $('#btnCopy')?.addEventListener('click', async ()=>{
    const url = buildWaLink();
    if (!url){ setStatus('Selecciona un contacto válido', false); return; }
    try{ await navigator.clipboard.writeText(url); setStatus('Enlace copiado'); }
    catch{ setStatus('No se pudo copiar', false); }
  });

  // Enter para loguear/crear
  ['loginUser','loginPass'].forEach(id => { const el=$('#'+id); el&&el.addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnLogin')?.click(); }); });
  ['setupUser','setupPass'].forEach(id => { const el=$('#'+id); el&&el.addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnSetup')?.click(); }); });

});
</script>

<!-- PWA: registrar Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js');
    });
  }
</script>
</body>
</html>
