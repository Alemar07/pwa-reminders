<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>MF Gestor de Citas</title>
  <meta name="theme-color" content="#5e5bff">
  <link rel="manifest" href="manifest.webmanifest?v=backup2">
  <link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html{ -webkit-text-size-adjust:100%; }
    :root{
      --bg1:#0b0e1a; --bg2:#11162a; --bg3:#0c2242;
      --violet:#5e5bff; --cyan:#10b5ff;
      --ink:#0b1220; --line: rgba(94,91,255,.22);
      --glassA: rgba(255,255,255,.86); --glassB: rgba(255,255,255,.82);
    }
    body{
      margin:0; overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(16,181,255,.25), transparent 60%),
        radial-gradient(1100px 600px at 90% 0%, rgba(94,91,255,.28), transparent 65%),
        linear-gradient(180deg, var(--bg3), var(--bg2) 55%, var(--bg1));
    }
    .card{ width:min(980px, 100%); margin:0 auto; background: linear-gradient(180deg, var(--glassA), var(--glassB)); }
    @media (min-width:900px){ .card{ border-radius:28px; box-shadow:0 40px 100px rgba(0,0,0,.25), 0 30px 70px rgba(94,91,255,.18) } }
    /* Header */
    .auth-head{ display:flex; align-items:center; gap:12px; padding:20px 16px 10px 16px }
    .logo-box{ width:46px; height:46px; border-radius:12px; overflow:hidden; flex:0 0 auto; box-shadow:0 10px 30px rgba(16,181,255,.25) }
    .logo-box img{ width:100%; height:100%; display:block; object-fit:cover; background:#fff }
    .title{ margin:0; font-size:clamp(22px, 3.8vw, 28px); color:var(--ink) }
    .subtitle{ margin:2px 0 0; font-size:clamp(12px, 2.4vw, 14px); color:#475569 }
    .hr{ height:1px; background:var(--line); margin:10px 0 0 }
    /* Main pegado arriba */
    .main{ padding:14px 16px 24px; overflow-anchor:none; }
    .stage{ display:none; }
    .stage-inner{ width:100%; max-width:600px; margin:12px auto 0; display:grid; gap:24px; }
    .row{ display:grid; grid-template-columns:1fr; gap:16px }
    .field{ position:relative; }
    .field input, .field select, .field textarea, .field [type="datetime-local"]{
      width:100%; border:1px solid rgba(94,91,255,.24); border-radius:18px;
      padding:16px 48px 16px 44px; background:rgba(255,255,255,.94);
      font-size:17px; color:var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 10px 24px rgba(94,91,255,.08);
    }
    .field select, .field input[type="datetime-local"]{ min-height:56px; }
    .field input[type="datetime-local"]{ -webkit-appearance:none; appearance:none; }
    .field textarea{ min-height:130px; resize:vertical; overflow:auto; }
    .icon-left, .icon-right{ position:absolute; top:50%; transform:translateY(-50%); width:22px; height:22px; opacity:.7 }
    .icon-left{ left:14px } .icon-right{ right:14px; cursor:pointer }
    label{ display:block; font-size:16px; color:#374151; margin:6px 0 8px; font-weight:700 }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:none; cursor:pointer; border-radius:22px; font-weight:800; color:white;
      padding:18px 18px; width:100%;
      background: linear-gradient(90deg, var(--cyan), var(--violet));
      box-shadow: 0 18px 34px rgba(16,181,255,.28), 0 18px 34px rgba(94,91,255,.28);
      letter-spacing:.2px;
    }
    .btn-ghost{ appearance:none; background:transparent; border:1px dashed rgba(94,91,255,.35); color:#0b1220; padding:14px 16px; border-radius:18px; font-weight:700; width:100%; }
    .btn-small{ padding:12px 14px; border-radius:14px; font-weight:700 }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }
    .section{ padding:12px 0 0 }
    .container{ width:100%; max-width:600px; margin-inline:auto; padding-inline:16px }
    .contact-block{
      background:linear-gradient(180deg, rgba(246,247,255,.9), rgba(243,246,255,.85));
      border:1px solid rgba(94,91,255,.22); border-radius:18px; padding:18px; box-shadow: 0 10px 26px rgba(94,91,255,.08);
    }
    .backup-block{
      background:linear-gradient(180deg, rgba(249,250,255,.92), rgba(245,248,255,.9));
      border:1px dashed rgba(94,91,255,.35); border-radius:18px; padding:18px; box-shadow: 0 8px 20px rgba(94,91,255,.06);
    }
    .btn-outline{ border:1px solid rgba(94,91,255,.35); background:#fff; color:#1f2a44; }
    .btn-danger{ background:linear-gradient(90deg,#ff6b6b,#ef4444); color:#fff; border:none }
    .footer{ padding:18px 16px 24px 16px; display:flex; justify-content:center; gap:18px; align-items:center }
    .chip{ padding:8px 12px; border-radius:999px; background:rgba(241,245,255,.9); border:1px solid rgba(94,91,255,.24); font-size:14px; color:#0b1220 }
    .logout{ color:#ef4444; text-decoration:underline; cursor:pointer; font-weight:700 }
  </style>
</head>
<body>
  <div class="card">
    <div class="auth-head">
      <div class="logo-box"><img src="icons/icon-192.png" alt="Logo" /></div>
      <div>
        <h1 id="hdrTitle" class="title">Iniciar sesión</h1>
        <p class="subtitle">MF Gestor de Citas</p>
      </div>
    </div>
    <div class="hr"></div>

    <main id="main" class="main">
      <section id="setupView" class="stage">
        <div class="stage-inner">
          <div class="row">
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
              <input id="setupUser" placeholder="Usuario" autocomplete="username">
            </div>
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a3 3 0 0 0-3 3v3h6v-3a3 3 0 0 0-3-3Zm0-7a5 5 0 0 1 5 5v3H7V10a5 5 0 0 1 5-5Z" fill="currentColor"/></svg>
              <input id="setupPass" type="password" placeholder="Contraseña" autocomplete="new-password">
              <svg id="toggleSetup" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z" fill="currentColor"/></svg>
            </div>
          </div>
          <div class="row"><button id="btnSetup" class="btn" type="button">Crear y acceder</button></div>
        </div>
      </section>

      <section id="loginView" class="stage">
        <div class="stage-inner">
          <div class="row">
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
              <input id="loginUser" placeholder="Usuario" autocomplete="username">
            </div>
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a3 3 0 0 0-3 3v3h6v-3a3 3 0 0 0-3-3Zm0-7a5 5 0 0 1 5 5v3H7V10a5 5 0 0 1 5-5Z" fill="currentColor"/></svg>
              <input id="loginPass" type="password" placeholder="Contraseña" autocomplete="current-password">
              <svg id="toggleLogin" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z" fill="currentColor"/></svg>
            </div>
          </div>
          <div class="row">
            <button id="btnLogin" class="btn" type="button">Entrar</button>
            <button id="btnReset" class="btn-ghost" type="button" style="display:none">Borrar datos de la app</button>
          </div>
          <div class="row">
            <input id="restoreInputLogin" type="file" accept="application/json" style="display:none">
            <button id="btnRestoreLogin" class="btn-ghost btn-small" type="button">Restaurar copia de seguridad…</button>
          </div>
        </div>
      </section>

      <section id="appView" class="stage" style="display:none">
        <div class="section">
          <div class="container grid2">
            <div>
              <label>Fecha y hora del recordatorio</label>
              <div class="field"><input id="dt" type="datetime-local" /></div>
            </div>
            <div>
              <label>Contacto</label>
              <div class="field"><select id="contactSelect"></select></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="container">
            <label>Mensaje a enviar</label>
            <div class="field"><textarea id="msg" rows="4" placeholder="Se generará automáticamente, pero puedes editarlo."></textarea></div>
          </div>
        </div>

        <div class="section">
          <div class="container"><button id="btnSend" class="btn" type="button">Enviar por WhatsApp</button></div>
        </div>

        <div class="section">
          <div class="container contact-block">
            <label style="margin-top:0">Gestionar contactos</label>
            <div class="grid2">
              <div class="field"><input id="newName" placeholder="Nombre" /></div>
              <div class="field"><input id="newPhone" placeholder="+34600111222" /></div>
            </div>
            <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap">
              <button id="btnAdd" class="btn btn-outline" type="button">Añadir contacto</button>
              <button id="btnRemove" class="btn btn-danger" type="button">Eliminar contacto</button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="container backup-block">
            <label style="margin-top:0">Copias de seguridad</label>
            <div style="display:flex; flex-wrap:wrap; gap:12px">
              <button id="btnExport" class="btn btn-outline" type="button">Exportar copia cifrada (.json)</button>
              <button id="btnExportCsv" class="btn btn-outline" type="button">Exportar CSV</button>
              <input id="restoreInputApp" type="file" accept="application/json" style="display:none">
              <button id="btnImportApp" class="btn btn-outline" type="button">Importar copia…</button>
            </div>
            <p style="margin:10px 0 0; color:#475569; font-size:14px">
              La copia <strong>.json</strong> está cifrada con tu contraseña. Para restaurar, importa el archivo y entra con tu contraseña.
            </p>
          </div>
        </div>

        <div class="footer">
          <span id="who" class="chip">Conectado: —</span>
          <span id="logout" class="logout" style="display:none">Cerrar sesión</span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Estado y cifrado
    const S = { key:null, user:null, stateKey:'wa-reminders-app-v1',
      state(){ const v=localStorage.getItem(this.stateKey); return v?JSON.parse(v):null; },
      save(o){ localStorage.setItem(this.stateKey, JSON.stringify(o)); },
      clear(){ localStorage.removeItem(this.stateKey); } };
    const $ = id => document.getElementById(id);
    const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const ubuf = s => Uint8Array.from(atob(s), c=>c.charCodeAt(0)).buffer;

    async function derive(password, saltB64){
      const salt=saltB64?ubuf(saltB64):crypto.getRandomValues(new Uint8Array(16)).buffer;
      const baseKey=await crypto.subtle.importKey('raw', new TextEncoder().encode(password),'PBKDF2',false,['deriveBits']);
      const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:250000,hash:'SHA-256'},baseKey,256);
      const keyBytes=new Uint8Array(bits);
      const pwHash=await crypto.subtle.digest('SHA-256', keyBytes);
      const aesKey=await crypto.subtle.importKey('raw', keyBytes,{name:'AES-GCM'},false,['encrypt','decrypt']);
      return {aesKey, pwHashB64:b64(pwHash), saltB64:b64(salt)};
    }
    async function encryptJson(aesKey,obj){ const iv=crypto.getRandomValues(new Uint8Array(12)); const data=new TextEncoder().encode(JSON.stringify(obj)); const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKey,data); return {iv:b64(iv),ct:b64(ct)}; }
    async function decryptJson(aesKey,pack){ const iv=ubuf(pack.iv), ct=ubuf(pack.ct); const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(iv)},aesKey,ct); return JSON.parse(new TextDecoder().decode(pt)); }

    // Descarga robusta (iOS/Android/desktop/PWA)
    async function saveFileSmart(filename, mime, content){
      let blob;
      if (typeof content === 'string') blob = new Blob([content], {type: mime});
      else if (content instanceof ArrayBuffer) blob = new Blob([new Uint8Array(content)], {type: mime});
      else blob = new Blob([content], {type: mime});

      // 1) Web Share API con archivos
      try {
        if (navigator.canShare && 'share' in navigator) {
          const file = new File([blob], filename, {type: mime});
          if (navigator.canShare({files: [file]})) {
            await navigator.share({files: [file], title: filename});
            return true;
          }
        }
      } catch(e) {}

      // 2) ObjectURL con <a download>
      try {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.rel='noopener';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){ } a.remove(); }, 1200);
        return true;
      } catch(e) {}

      // 3) data: URL en pestaña nueva
      try {
        const buf = await blob.arrayBuffer();
        let binary = ''; const bytes = new Uint8Array(buf);
        for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
        const base64 = btoa(binary);
        const dataUrl = 'data:' + mime + ';base64,' + base64;
        window.open(dataUrl, '_blank');
        return true;
      } catch(e) {}

      // 4) Copiar texto
      try {
        if (typeof content === 'string' && navigator.clipboard) {
          await navigator.clipboard.writeText(content);
          alert('No se pudo descargar. He copiado el contenido al portapapeles.');
          return true;
        }
      } catch(e) {}
      alert('No se pudo descargar el archivo en este navegador.');
      return false;
    }
    const saveJson = (name, obj) => saveFileSmart(name, 'application/json', JSON.stringify(obj, null, 2));
    const saveCsv  = (name, csv) => saveFileSmart(name, 'text/csv', csv);

    // UI helpers
    function setHeaderTitle(t){ const h=$('hdrTitle'); if(h) h.textContent=t; }
    function toggleResetVisibility(){ const reset=$('btnReset'); if(reset) reset.style.display = S.state() ? 'inline-flex' : 'none'; }
    function show(id){
      ['setupView','loginView','appView'].forEach(v=>{ const el=$(v); if(el) el.style.display=(v===id?'block':'none'); });
      $('logout') && ($('logout').style.display = id==='appView' ? 'inline' : 'none');
      if(id==='appView'){ setHeaderTitle('Enviar cita'); } else { setHeaderTitle('Iniciar sesión'); }
      if(id==='loginView'){ toggleResetVisibility(); }
      if(id==='setupView'){ const r=$('btnReset'); if(r) r.style.display='none'; }
      window.scrollTo(0,0); document.documentElement.scrollTop = 0; document.body.scrollTop = 0;
    }

    function setDefaultDate(){
      const d=new Date(Date.now()+60*60*1000);
      const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
      $('dt') && ($('dt').value=iso);
    }
    const isPhoneValid = p => /^\+\d{6,15}$/.test(p);
    function refreshContactsSelect(list){
      const sel=$('contactSelect'); if(!sel) return;
      sel.innerHTML='';
      if(!list || !list.length){ const o=document.createElement('option'); o.value=''; o.text='— Sin contactos —'; sel.add(o); return; }
      list.forEach(c=>{ const o=document.createElement('option'); o.value=c.phone; o.text=`${c.name} (${c.phone})`; sel.add(o); });
    }
    function buildMessage(){
      const v=$('dt')?.value||''; const when=v?new Date(v):new Date();
      const d=when.toLocaleDateString(undefined,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
      const t=when.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      return `¡Hola! 👋 Tienes un recordatorio para el ${d} a las ${t}.`;
    }
    function updateMessage(){ const m=$('msg'); if(m) m.value=buildMessage(); }

    // Descarga/subida helpers
    function pickFileOnce(inputEl, handler){
      inputEl.value='';
      inputEl.onchange=async (e)=>{
        const f=e.target.files && e.target.files[0];
        if(!f) return;
        try{ await handler(f); } finally { inputEl.value=''; }
      };
      inputEl.click();
    }

    async function exportEncryptedBackup(){
      const st=S.state();
      if(!st){ alert('No hay datos que exportar todavía. Crea tu usuario primero.'); return; }
      const backup = {
        format: 'mf-contacts-v1',
        user: st.user,
        saltB64: st.saltB64,
        pwHashB64: st.pwHashB64,
        vault: st.vault,
        timestamp: new Date().toISOString()
      };
      saveJson(`copia-contactos-${st.user}.json`, backup);
    }
    async function exportCSV(){
      if(!S.key){ alert('Inicia sesión para exportar CSV.'); return; }
      const st=S.state(); if(!st){ alert('No hay datos.'); return; }
      const vault=await decryptJson(S.key, st.vault);
      const rows=[['nombre','telefono'], ...vault.list.map(c=>[c.name, c.phone])];
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      saveCsv('contactos.csv', csv);
    }
    async function importBackupFromFile(file){
      const text=await file.text();
      let data;
      try{ data=JSON.parse(text); }catch(_){ alert('Archivo no válido'); return; }
      if(!data || data.format!=='mf-contacts-v1' || !data.vault || !data.saltB64 || !data.pwHashB64){
        alert('Copia no reconocida'); return;
      }
      const exists=S.state();
      if(exists && !confirm('Esto reemplazará los datos actuales por la copia importada. ¿Continuar?')) return;
      S.save({ user: data.user || 'Usuario', saltB64:data.saltB64, pwHashB64:data.pwHashB64, vault:data.vault });
      S.key=null;
      alert('Copia importada. Ahora inicia sesión con tu contraseña para acceder a tus contactos.');
      show('loginView');
    }

    function wireEvents(){
      const toggle = id => { const i=$(id); if(i) i.type = i.type==='password' ? 'text' : 'password'; };
      $('toggleLogin')?.addEventListener('click', ()=>toggle('loginPass'));
      $('toggleSetup')?.addEventListener('click', ()=>toggle('setupPass'));

      $('btnSetup')?.addEventListener('click', async ()=>{
        const user=$('setupUser').value.trim(), pass=$('setupPass').value;
        if(!user){ alert('Introduce un usuario'); return; }
        if(pass.length<6){ alert('La contraseña debe tener al menos 6 caracteres'); return; }
        try{
          const r=await derive(pass); S.key=r.aesKey; S.user=user;
          const pack=await encryptJson(S.key,{list:[]});
          S.save({user, pwHashB64:r.pwHashB64, saltB64:r.saltB64, vault:pack});
          $('who') && ($('who').textContent=`Conectado: ${user}`);
          refreshContactsSelect([]); show('appView');
        }catch(e){ console.error(e); alert('Error creando el almacén'); }
      });

      $('btnLogin')?.addEventListener('click', async ()=>{
        const user=$('loginUser').value.trim(), pass=$('loginPass').value;
        const state=S.state(); if(!state){ show('setupView'); return; }
        if(user!==state.user){ alert('Usuario incorrecto'); return; }
        try{
          const r=await derive(pass, state.saltB64);
          if(r.pwHashB64!==state.pwHashB64){ alert('Contraseña incorrecta'); return; }
          const vault=await decryptJson(r.aesKey, state.vault);
          S.key=r.aesKey; S.user=user;
          $('who') && ($('who').textContent=`Conectado: ${user}`);
          refreshContactsSelect(vault.list); show('appView');
        }catch(e){ console.error(e); alert('Error al descifrar datos'); }
      });

      $('logout')?.addEventListener('click', ()=>{
        show('loginView');
        const lp=$('loginPass'); if(lp) lp.value='';
        toggleResetVisibility();
      });

      $('btnReset')?.addEventListener('click', ()=>{
        if(confirm('Esto borrará TODA la app (usuario, contactos). ¿Continuar?')){ S.clear(); location.reload(); }
      });

      const loadVault = async ()=>{ const st=S.state(); return st?await decryptJson(S.key, st.vault):{list:[]}; };
      const saveVault = async v=>{ const pack=await encryptJson(S.key,v); const st=S.state(); st.vault=pack; S.save(st); };

      $('btnAdd')?.addEventListener('click', async ()=>{
        const name=$('newName').value.trim(), phone=$('newPhone').value.trim();
        if(!name){ alert('Introduce un nombre'); return; }
        if(!isPhoneValid(phone)){ alert('Teléfono inválido. Usa formato internacional: +34600111222'); return; }
        const vault=await loadVault();
        if(vault.list.some(c=>c.phone===phone)){ alert('Ese teléfono ya existe'); return; }
        vault.list.push({name, phone}); await saveVault(vault);
        refreshContactsSelect(vault.list); $('newName').value=''; $('newPhone').value='';
      });

      $('btnRemove')?.addEventListener('click', async ()=>{
        const sel=$('contactSelect'); const phone=sel?sel.value:'';
        if(!phone){ alert('No hay contacto seleccionado'); return; }
        const vault=await loadVault(); const before=vault.list.length;
        vault.list=vault.list.filter(c=>c.phone!==phone); await saveVault(vault);
        refreshContactsSelect(vault.list);
        if(before===vault.list.length) alert('No se encontró el contacto');
      });

      $('dt')?.addEventListener('change', updateMessage);
      $('btnSend')?.addEventListener('click', ()=>{
        const sel=$('contactSelect'); const phone=sel?sel.value:'';
        if(!isPhoneValid(phone)){ alert('Selecciona un contacto válido'); return; }
        const text=encodeURIComponent(($('msg')?.value||buildMessage()).trim());
        const url=`https://wa.me/${phone.replace('+','')}/?text=${text}`;
        window.open(url,'_blank');
      });

      // Backups
      $('btnExport')?.addEventListener('click', exportEncryptedBackup);
      $('btnExportCsv')?.addEventListener('click', exportCSV);
      $('btnImportApp')?.addEventListener('click', ()=>pickFileOnce($('restoreInputApp'), importBackupFromFile));
      $('btnRestoreLogin')?.addEventListener('click', ()=>pickFileOnce($('restoreInputLogin'), importBackupFromFile));

      ['loginUser','loginPass','setupUser','setupPass'].forEach(id=>{
        const el=$(id); el&&el.addEventListener('keydown',e=>{
          if(e.key==='Enter'){ (id.startsWith('login')?$('btnLogin'):$('btnSetup'))?.click(); }
        });
      });
    }

    if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
    function toTop(){ window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0; }

    function init(){
      const state=S.state();
      show(state? 'loginView' : 'setupView');
      setDefaultDate(); updateMessage(); wireEvents();
      setTimeout(toTop, 40);
    }
    document.addEventListener('DOMContentLoaded', init);
    window.addEventListener('pageshow', function(e){ if(e.persisted) toTop(); });
    window.addEventListener('orientationchange', function(){ setTimeout(toTop, 60); });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js?v=backup2').catch(()=>{});
      });
    }
  </script>
</body>
</html>
