<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>MF Gestor de Citas</title>
<meta name="theme-color" content="#5e5bff">
<!--<link rel="manifest" href="manifest.webmanifest?v=topfull">-->
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<meta name="theme-color" content="#5e5bff">

<style>
  *, *::before, *::after { box-sizing: border-box; }
  html{ -webkit-text-size-adjust:100%; }
  :root{
    --bg1:#0b0e1a; --bg2:#11162a; --bg3:#0c2242;
    --violet:#5e5bff; --cyan:#10b5ff;
    --ink:#0b1220; --line: rgba(94,91,255,.22);
    --glassA: rgba(255,255,255,.86); --glassB: rgba(255,255,255,.82);
  }
  body{
    margin:0; overflow-x:hidden;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
    background:
      radial-gradient(900px 500px at 10% -10%, rgba(16,181,255,.25), transparent 60%),
      radial-gradient(1100px 600px at 90% 0%, rgba(94,91,255,.28), transparent 65%),
      linear-gradient(180deg, var(--bg3), var(--bg2) 55%, var(--bg1));
  }
  .card{ width:min(980px, 100%); margin:0 auto; background: linear-gradient(180deg, var(--glassA), var(--glassB)); }
  @media (min-width:900px){ .card{ border-radius:28px; box-shadow:0 40px 100px rgba(0,0,0,.25), 0 30px 70px rgba(94,91,255,.18) } }

  .auth-head{ display:flex; align-items:center; gap:12px; padding:24px 20px 8px }
  .logo{ width:46px; height:46px; border-radius:12px; color:#fff; font-weight:800; display:grid; place-items:center;
         background:linear-gradient(135deg, var(--cyan), var(--violet)); box-shadow:0 10px 30px rgba(16,181,255,.25); }
  .title{ margin:0; font-size:clamp(22px,3.8vw,28px); color:var(--ink) }
  .subtitle{ margin:2px 0 0; font-size:clamp(12px,2.4vw,14px); color:#475569 }
  .hr{ height:1px; background:var(--line); margin:10px 0 0 }

  /* Main pegado arriba */
  .main{ padding:14px 16px 24px; overflow-anchor:none; }
  .stage{ display:none; }
  .stage-inner{ width:100%; max-width:600px; margin:12px auto 0; display:grid; gap:24px; }
  .row{ display:grid; grid-template-columns:1fr; gap:16px }

  .field{ position:relative; }
  .field input, .field select, .field textarea, .field [type="datetime-local"]{
    width:100%; border:1px solid rgba(94,91,255,.24); border-radius:18px;
    padding:16px 48px 16px 44px; background:rgba(255,255,255,.94);
    font-size:17px; color:var(--ink);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.6), 0 10px 24px rgba(94,91,255,.08);
  }
  .field select, .field input[type="datetime-local"]{ min-height:56px; }
  .field input[type="datetime-local"]{ -webkit-appearance:none; appearance:none; }
  .field textarea{ min-height:130px; resize:vertical; overflow:auto; }
  .icon-left, .icon-right{ position:absolute; top:50%; transform:translateY(-50%); width:22px; height:22px; opacity:.7 }
  .icon-left{ left:14px } .icon-right{ right:14px; cursor:pointer }
  label{ display:block; font-size:16px; color:#374151; margin:6px 0 8px; font-weight:700 }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    border:none; cursor:pointer; border-radius:22px; font-weight:800; color:white;
    padding:18px 18px; width:100%;
    background: linear-gradient(90deg, var(--cyan), var(--violet));
    box-shadow: 0 18px 34px rgba(16,181,255,.28), 0 18px 34px rgba(94,91,255,.28);
    letter-spacing:.2px;
  }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
  @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }
  .section{ padding:12px 0 0 }
  .container{ width:100%; max-width:600px; margin-inline:auto; padding-inline:16px }
  .contact-block{
    background:linear-gradient(180deg, rgba(246,247,255,.9), rgba(243,246,255,.85));
    border:1px solid rgba(94,91,255,.22); border-radius:18px; padding:18px;
    box-shadow: 0 10px 26px rgba(94,91,255,.08);
  }
  .btn-outline{ border:1px solid rgba(94,91,255,.35); background:#fff; color:#1f2a44; }
  .btn-danger{ background:linear-gradient(90deg,#ff6b6b,#ef4444); color:#fff; border:none }

  .footer{ padding:18px 16px 24px 16px; display:flex; justify-content:center; gap:18px; align-items:center }
  .chip{ padding:8px 12px; border-radius:999px; background:rgba(241,245,255,.9); border:1px solid rgba(94,91,255,.24); font-size:14px; color:#0b1220 }
  .logout{ color:#ef4444; text-decoration:underline; cursor:pointer; font-weight:700 }
</style>
</head>
<body>
  <div class="card">

    <!-- Header -->
    <div class="auth-head">
      <div class="logo">MF</div>
      <div>
        <h1 id="hdrTitle" class="title">Iniciar sesión</h1>
        <p class="subtitle">MF Gestor de Citas</p>
      </div>
    </div>
    <div class="hr"></div>

    <!-- Main (todas las vistas) -->
    <main id="main" class="main">
      <!-- SETUP -->
      <section id="setupView" class="stage">
        <div class="stage-inner">
          <div class="row">
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
              <input id="setupUser" placeholder="Usuario" autocomplete="username">
            </div>
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a3 3 0 0 0-3 3v3h6v-3a3 3 0 0 0-3-3Zm0-7a5 5 0 0 1 5 5v3H7V10a5 5 0 0 1 5-5Z" fill="currentColor"/></svg>
              <input id="setupPass" type="password" placeholder="Contraseña" autocomplete="new-password">
              <svg id="toggleSetup" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z" fill="currentColor"/></svg>
            </div>
          </div>
          <div class="row"><button id="btnSetup" class="btn" type="button">Crear y acceder</button></div>
        </div>
      </section>

      <!-- LOGIN -->
      <section id="loginView" class="stage">
        <div class="stage-inner">
          <div class="row">
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6v1h16v-1c0-3.33-2.67-6-8-6Z" fill="currentColor"/></svg>
              <input id="loginUser" placeholder="Usuario" autocomplete="username">
            </div>
            <div class="field">
              <svg class="icon-left" viewBox="0 0 24 24" fill="none"><path d="M12 12a3 3 0 0 0-3 3v3h6v-3a3 3 0 0 0-3-3Zm0-7a5 5 0 0 1 5 5v3H7V10a5 5 0 0 1 5-5Z" fill="currentColor"/></svg>
              <input id="loginPass" type="password" placeholder="Contraseña" autocomplete="current-password">
              <svg id="toggleLogin" class="icon-right" viewBox="0 0 24 24" fill="none"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7Zm0 12a5 5 0 1 1 5-5 5 5 0 0 1-5 5Z" fill="currentColor"/></svg>
            </div>
          </div>
          <div class="row">
            <button id="btnLogin" class="btn" type="button">Entrar</button>
            <button id="btnReset" class="btn" type="button" style="display:none;background:transparent;color:#0b1220;border:1px dashed rgba(94,91,255,.35)">Borrar datos de la app</button>
          </div>
        </div>
      </section>

      <!-- APP -->
      <section id="appView" class="stage" style="display:none">
        <div class="section">
          <div class="container grid2">
            <div>
              <label>Fecha y hora del recordatorio</label>
              <div class="field"><input id="dt" type="datetime-local" /></div>
            </div>
            <div>
              <label>Contacto</label>
              <div class="field"><select id="contactSelect"></select></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="container">
            <label>Mensaje a enviar</label>
            <div class="field"><textarea id="msg" rows="4" placeholder="Se generará automáticamente, pero puedes editarlo."></textarea></div>
          </div>
        </div>

        <div class="section">
          <div class="container"><button id="btnSend" class="btn" type="button">Enviar por WhatsApp</button></div>
        </div>

        <div class="section">
          <div class="container contact-block">
            <label style="margin-top:0">Gestionar contactos</label>
            <div class="grid2">
              <div class="field"><input id="newName" placeholder="Nombre" /></div>
              <div class="field"><input id="newPhone" placeholder="+34600111222" /></div>
            </div>
            <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap">
              <button id="btnAdd" class="btn btn-outline" type="button">Añadir contacto</button>
              <button id="btnRemove" class="btn btn-danger" type="button">Eliminar contacto</button>
            </div>
          </div>
        </div>

        <div class="footer">
          <span id="who" class="chip">Conectado: —</span>
          <span id="logout" class="logout" style="display:none">Cerrar sesión</span>
        </div>
      </section>

    </main>
  </div>

<script>
// ---------- Utilidades de estado y cifrado ----------
const S = { key:null, user:null, stateKey:'wa-reminders-app-v1',
  state(){ const v=localStorage.getItem(this.stateKey); return v?JSON.parse(v):null; },
  save(o){ localStorage.setItem(this.stateKey, JSON.stringify(o)); },
  clear(){ localStorage.removeItem(this.stateKey); } };
const $ = id => document.getElementById(id);
const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const ubuf = s => Uint8Array.from(atob(s), c=>c.charCodeAt(0)).buffer;

async function derive(password, saltB64){
  const salt=saltB64?ubuf(saltB64):crypto.getRandomValues(new Uint8Array(16)).buffer;
  const baseKey=await crypto.subtle.importKey('raw', new TextEncoder().encode(password),'PBKDF2',false,['deriveBits']);
  const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:250000,hash:'SHA-256'},baseKey,256);
  const keyBytes=new Uint8Array(bits);
  const pwHash=await crypto.subtle.digest('SHA-256', keyBytes);
  const aesKey=await crypto.subtle.importKey('raw', keyBytes,{name:'AES-GCM'},false,['encrypt','decrypt']);
  return {aesKey, pwHashB64:b64(pwHash), saltB64:b64(salt)};
}
async function encryptJson(aesKey,obj){ const iv=crypto.getRandomValues(new Uint8Array(12)); const data=new TextEncoder().encode(JSON.stringify(obj)); const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKey,data); return {iv:b64(iv),ct:b64(ct)}; }
async function decryptJson(aesKey,pack){ const iv=ubuf(pack.iv), ct=ubuf(pack.ct); const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(iv)},aesKey,ct); return JSON.parse(new TextDecoder().decode(pt)); }

// ---------- UI helpers ----------
function setHeaderTitle(t){ const h=$('hdrTitle'); if(h) h.textContent=t; }
function toggleResetVisibility(){ const reset=$('btnReset'); if(reset) reset.style.display = S.state() ? 'inline-flex' : 'none'; }
function show(id){
  ['setupView','loginView','appView'].forEach(v=>{ const el=$(v); if(el) el.style.display=(v===id?'block':'none'); });
  $('logout') && ($('logout').style.display = id==='appView' ? 'inline' : 'none');
  if(id==='appView'){ setHeaderTitle('Enviar cita'); }
  else { setHeaderTitle('Iniciar sesión'); }
  if(id==='loginView'){ toggleResetVisibility(); }
  if(id==='setupView'){ const r=$('btnReset'); if(r) r.style.display='none'; }
  // Asegura scroll arriba
  window.scrollTo(0,0); document.documentElement.scrollTop = 0; document.body.scrollTop = 0;
}

// ---------- Datos ----------
function setDefaultDate(){
  const d=new Date(Date.now()+60*60*1000);
  const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  $('dt') && ($('dt').value=iso);
}
const isPhoneValid = p => /^\+\d{6,15}$/.test(p);
function refreshContactsSelect(list){
  const sel=$('contactSelect'); if(!sel) return;
  sel.innerHTML='';
  if(!list || !list.length){ const o=document.createElement('option'); o.value=''; o.text='— Sin contactos —'; sel.add(o); return; }
  list.forEach(c=>{ const o=document.createElement('option'); o.value=c.phone; o.text=`${c.name} (${c.phone})`; sel.add(o); });
}
function buildMessage(){
  const v=$('dt')?.value||''; const when=v?new Date(v):new Date();
  const d=when.toLocaleDateString(undefined,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const t=when.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
  return `¡Hola! 👋 Tienes un recordatorio para el ${d} a las ${t}.`;
}
function updateMessage(){ const m=$('msg'); if(m) m.value=buildMessage(); }

// ---------- Lógica de la app ----------
function wireEvents(){
  const toggle = id => { const i=$(id); if(i) i.type = i.type==='password' ? 'text' : 'password'; };
  $('toggleLogin')?.addEventListener('click', ()=>toggle('loginPass'));
  $('toggleSetup')?.addEventListener('click', ()=>toggle('setupPass'));

  // Crear cuenta (setup)
  $('btnSetup')?.addEventListener('click', async ()=>{
    const user=$('setupUser').value.trim(), pass=$('setupPass').value;
    if(!user){ alert('Introduce un usuario'); return; }
    if(pass.length<6){ alert('La contraseña debe tener al menos 6 caracteres'); return; }
    try{
      const r=await derive(pass); S.key=r.aesKey; S.user=user;
      const pack=await encryptJson(S.key,{list:[]});
      S.save({user, pwHashB64:r.pwHashB64, saltB64:r.saltB64, vault:pack});
      $('who') && ($('who').textContent=`Conectado: ${user}`);
      refreshContactsSelect([]); show('appView');
    }catch(e){ console.error(e); alert('Error creando el almacén'); }
  });

  // Login
  $('btnLogin')?.addEventListener('click', async ()=>{
    const user=$('loginUser').value.trim(), pass=$('loginPass').value;
    const state=S.state(); if(!state){ show('setupView'); return; }
    if(user!==state.user){ alert('Usuario incorrecto'); return; }
    try{
      const r=await derive(pass, state.saltB64);
      if(r.pwHashB64!==state.pwHashB64){ alert('Contraseña incorrecta'); return; }
      const vault=await decryptJson(r.aesKey, state.vault);
      S.key=r.aesKey; S.user=user;
      $('who') && ($('who').textContent=`Conectado: ${user}`);
      refreshContactsSelect(vault.list); show('appView');
    }catch(e){ console.error(e); alert('Error al descifrar datos'); }
  });

  // Logout y Reset
  $('logout')?.addEventListener('click', ()=>{
    show('loginView');
    const lp=$('loginPass'); if(lp) lp.value='';
    toggleResetVisibility();
  });
  $('btnReset')?.addEventListener('click', ()=>{
    if(confirm('Esto borrará TODA la app (usuario, contactos). ¿Continuar?')){ S.clear(); location.reload(); }
  });

  // Contactos
  const loadVault = async ()=>{ const st=S.state(); return st?await decryptJson(S.key, st.vault):{list:[]}; };
  const saveVault = async v=>{ const pack=await encryptJson(S.key,v); const st=S.state(); st.vault=pack; S.save(st); };

  $('btnAdd')?.addEventListener('click', async ()=>{
    const name=$('newName').value.trim(), phone=$('newPhone').value.trim();
    if(!name){ alert('Introduce un nombre'); return; }
    if(!isPhoneValid(phone)){ alert('Teléfono inválido. Usa formato internacional: +34600111222'); return; }
    const vault=await loadVault();
    if(vault.list.some(c=>c.phone===phone)){ alert('Ese teléfono ya existe'); return; }
    vault.list.push({name, phone}); await saveVault(vault);
    refreshContactsSelect(vault.list); $('newName').value=''; $('newPhone').value='';
  });

  $('btnRemove')?.addEventListener('click', async ()=>{
    const sel=$('contactSelect'); const phone=sel?sel.value:'';
    if(!phone){ alert('No hay contacto seleccionado'); return; }
    const vault=await loadVault(); const before=vault.list.length;
    vault.list=vault.list.filter(c=>c.phone!==phone); await saveVault(vault);
    refreshContactsSelect(vault.list);
    if(before===vault.list.length) alert('No se encontró el contacto');
  });

  // Mensaje y envío
  $('dt')?.addEventListener('change', updateMessage);
  function waLink(){
    const sel=$('contactSelect'); const phone=sel?sel.value:''; if(!isPhoneValid(phone)) return null;
    const text=encodeURIComponent(($('msg')?.value||buildMessage()).trim());
    return `https://wa.me/${phone.replace('+','')}/?text=${text}`;
  }
  $('btnSend')?.addEventListener('click', ()=>{
    const url=waLink(); if(!url){ alert('Selecciona un contacto válido'); return; }
    window.open(url,'_blank');
  });

  // Enter para enviar
  ['loginUser','loginPass','setupUser','setupPass'].forEach(id=>{
    const el=$(id); el&&el.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ (id.startsWith('login')?$('btnLogin'):$('btnSetup'))?.click(); }
    });
  });
}

// ---------- Init ----------
if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
function toTop(){ window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0; }

function init(){
  const state=S.state();
  show(state? 'loginView' : 'setupView');
  setDefaultDate(); updateMessage(); wireEvents();
  setTimeout(toTop, 40);
}
document.addEventListener('DOMContentLoaded', init);
window.addEventListener('pageshow', function(e){ if(e.persisted) toTop(); });
window.addEventListener('orientationchange', function(){ setTimeout(toTop, 60); });
</script>

<script>
  // Mantengo el SW pero con versión para romper caché
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./service-worker.js?v=topfull').catch(()=>{});
    });
  }
</script>
</body>
</html>
